rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSuperAdmin(request) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    function isCommunityAdmin(request) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Admin requests collection
    match /admin_requests/{requestId} {
      allow read: if isSuperAdmin(request);
      allow create: if request.auth != null;  // Anyone can submit a request
      allow update, delete: if isSuperAdmin(request);
    }

    // Communities collection
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin(request) || 
                  (isCommunityAdmin(request) && 
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.communityId == communityId);
    }

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        isSuperAdmin(request) || 
        (isCommunityAdmin(request) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.communityId == 
         get(/databases/$(database)/documents/users/$(userId)).data.communityId)
      );
      allow write: if isSuperAdmin(request) || (request.auth != null && request.auth.uid == userId);
    }

    // Market items collection rules
    match /market_items/{itemId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
                   request.resource.data.sellerId == request.auth.uid;
      
      allow update: if request.auth != null && (
        resource.data.sellerId == request.auth.uid ||
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['buyerUnreadCount', 'sellerUnreadCount', 'buyerId']) &&
          (
            resource.data.buyerId == request.auth.uid || 
            request.resource.data.buyerId == request.auth.uid ||
            resource.data.sellerId == request.auth.uid
          )
        )
      );
      
      allow delete: if request.auth != null && 
                   resource.data.sellerId == request.auth.uid;
    }

    // Volunteer posts collection rules
    match /volunteer_posts/{postId} {
      allow read, list: if request.auth != null;
      
      allow create: if request.auth != null && 
                   request.resource.data.userId == request.auth.uid;
      
      allow update: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
      
      allow delete: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
    }

    // Deny access to other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
