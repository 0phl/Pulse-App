rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSuperAdmin(request) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    function isAdmin(request) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function canAccessStats(request) {
      return isAdmin(request) || isSuperAdmin(request);
    }
    
    function getUserCommunityId(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.communityId;
    }
    
    function inSameCommunity(request, targetUserId) {
      return getUserCommunityId(request.auth.uid) == getUserCommunityId(targetUserId);
    }

    // Admin requests collection
    match /admin_requests/{requestId} {
      allow read: if isSuperAdmin(request) || isAdmin(request);
      allow create: if request.auth != null;  // Anyone can submit a request
      allow update, delete: if isSuperAdmin(request);
    }

    // Communities collection
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin(request) || isAdmin(request);
    }

// Users collection
match /users/{userId} {
  // Anyone can read user data for email verification during registration
  allow read: if true;
  
  // Users can create their own documents
  allow create: if request.auth != null && request.auth.uid == userId;
  
  // Users can update their own documents, admins and super admins can update any user
  allow update: if request.auth != null && (
    request.auth.uid == userId ||
    isSuperAdmin(request) ||
    isAdmin(request)
  );
  
  // Only super admins can delete users
  allow delete: if isSuperAdmin(request);
}

    // Market items collection rules
    match /market_items/{itemId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
                   request.resource.data.sellerId == request.auth.uid;
      
      allow update: if request.auth != null && (
        resource.data.sellerId == request.auth.uid ||
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['buyerUnreadCount', 'sellerUnreadCount', 'buyerId']) &&
          (
            resource.data.buyerId == request.auth.uid || 
            request.resource.data.buyerId == request.auth.uid ||
            resource.data.sellerId == request.auth.uid
          )
        )
      );
      
      allow delete: if request.auth != null && (
                   resource.data.sellerId == request.auth.uid ||
                   isAdmin(request) ||
                   isSuperAdmin(request)
                   );
    }

    // Volunteer posts collection rules
    match /volunteer_posts/{postId} {
      allow read, list: if request.auth != null;
      
      allow create: if request.auth != null && 
                   request.resource.data.userId == request.auth.uid;
      
      allow update: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
      
      allow delete: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
    }

    // Audit logs collection
    match /audit_logs/{logId} {
      function isVolunteerAction(actionType) {
        return actionType in ['VOLUNTEER_SIGNED_UP', 'VOLUNTEER_CANCELLED'];
      }

      allow read: if isAdmin(request) || isSuperAdmin(request);
      allow create: if request.auth != null; // Any authenticated user can create audit logs
      allow update, delete: if false; // Audit logs should never be modified or deleted
    }

    // Collection statistics access
    match /market_items/{document=**} {
      allow read, count: if canAccessStats(request);
    }
    
    match /volunteer_posts/{document=**} {
      allow read, count: if canAccessStats(request);
    }
    
    match /community_notices/{document=**} {
      allow read, count: if canAccessStats(request);
    }
    
    match /chats/{document=**} {
      allow read, count: if canAccessStats(request);
    }
    
    match /reports/{document=**} {
      allow read, count: if canAccessStats(request);
    }

    // Deny access to other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
